[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;34m🚀 SmartKubik Safe Deploy Script[0m
[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m

[0;34m[INFO][0m Verificando conexión al servidor...
[0;32m[✓][0m Conexión establecida
[0;34m[INFO][0m Verificando que el backend esté corriendo...
[0;32m[✓][0m Backend está corriendo (2 instancia(s))
[0;34m[INFO][0m Creando backup del código actual...
[0;34m[INFO][0m Copiando código...
[0;34m[INFO][0m Guardando estado de PM2...
[PM2] Saving current process list...
[PM2] Successfully saved in /home/deployer/.pm2/dump.pm2
[0;32m[✓][0m Backup creado: /home/deployer/backups/smartkubik-20251016-201103 (2.0G)
[0;34m[INFO][0m Obteniendo código más reciente desde GitHub...
[0;34m[INFO][0m Configurando remote para usar HTTPS...
From https://github.com/jualfel30-eng/smartkubik
   55ead230b..eb959c458  main       -> origin/main
[0;34m[INFO][0m Hay cambios nuevos disponibles
[0;34m[INFO][0m Haciendo pull...
From https://github.com/jualfel30-eng/smartkubik
 * branch                main       -> FETCH_HEAD
Updating 55ead230b..eb959c458
Fast-forward
 food-inventory-admin/src/components/WhatsAppConnection.jsx | 2 +-
 safe-deploy.sh                                             | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)
[0;32m[✓][0m Código actualizado
[0;34m[INFO][0m Compilando backend...
[0;34m[INFO][0m Instalando dependencias del backend...
npm warn deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
npm warn deprecated npmlog@5.0.1: This package is no longer supported.
npm warn deprecated supertest@6.3.4: Please upgrade to supertest v7.1.3+, see release notes at https://github.com/forwardemail/supertest/releases/tag/v7.1.3 - maintenance is supported by Forward Email @ https://forwardemail.net
npm warn deprecated @humanwhocodes/config-array@0.13.0: Use @eslint/config-array instead
npm warn deprecated rimraf@3.0.2: Rimraf versions prior to v4 are no longer supported
npm warn deprecated are-we-there-yet@2.0.0: This package is no longer supported.
npm warn deprecated @humanwhocodes/object-schema@2.0.3: Use @eslint/object-schema instead
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm warn deprecated gauge@3.0.2: This package is no longer supported.
npm warn deprecated superagent@8.1.2: Please upgrade to superagent v10.2.2+, see release notes at https://github.com/forwardemail/superagent/releases/tag/v10.2.2 - maintenance is supported by Forward Email @ https://forwardemail.net
npm warn deprecated eslint@8.57.1: This version is no longer supported. Please see https://eslint.org/version-support for other options.

added 1067 packages, and audited 1068 packages in 15s

154 packages are looking for funding
  run `npm fund` for details

19 vulnerabilities (16 moderate, 3 high)

To address issues that do not require attention, run:
  npm audit fix

To address all issues possible (including breaking changes), run:
  npm audit fix --force

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
[0;34m[INFO][0m Compilando código del backend...

> food-inventory-saas@1.0.0 build
> nest build

webpack 5.100.2 compiled [1m[32msuccessfully[39m[22m in 13645 ms
[0;34m[INFO][0m Verificando que dist/main.js existe...
[0;32m[✓][0m Backend compilado exitosamente
[0;34m[INFO][0m Compilando frontend...
[0;34m[INFO][0m Instalando dependencias del frontend...
npm warn deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
npm warn deprecated rimraf@2.7.1: Rimraf versions prior to v4 are no longer supported
npm warn deprecated lodash.isequal@4.5.0: This package is deprecated. Use require('node:util').isDeepStrictEqual instead.
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm warn deprecated fstream@1.0.12: This package is no longer supported.
npm warn deprecated popper.js@1.16.1: You can find the new Popper v2 at @popperjs/core, this package is dedicated to the legacy v1

added 632 packages, and audited 633 packages in 11s

83 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
[0;34m[INFO][0m Compilando código del frontend...

> food-inventory-admin@0.0.0 build
> vite build

vite v6.3.6 building for production...
transforming...
✓ 1717 modules transformed.
✗ Build failed in 2.87s
error during build:
[vite]: Rollup failed to resolve import "axios" from "/home/deployer/smartkubik/food-inventory-admin/src/lib/chatApi.js".
This is most likely unintended because it can break your application at runtime.
If you do want to externalize this module explicitly add it to
`build.rollupOptions.external`
    at viteLog (file:///home/deployer/smartkubik/food-inventory-admin/node_modules/vite/dist/node/chunks/dep-Bu492Fnd.js:46363:15)
    at file:///home/deployer/smartkubik/food-inventory-admin/node_modules/vite/dist/node/chunks/dep-Bu492Fnd.js:46421:18
    at onwarn (file:///home/deployer/smartkubik/food-inventory-admin/node_modules/@vitejs/plugin-react/dist/index.js:90:7)
    at file:///home/deployer/smartkubik/food-inventory-admin/node_modules/vite/dist/node/chunks/dep-Bu492Fnd.js:46419:7
    at onRollupLog (file:///home/deployer/smartkubik/food-inventory-admin/node_modules/vite/dist/node/chunks/dep-Bu492Fnd.js:46411:5)
    at onLog (file:///home/deployer/smartkubik/food-inventory-admin/node_modules/vite/dist/node/chunks/dep-Bu492Fnd.js:46061:7)
    at file:///home/deployer/smartkubik/food-inventory-admin/node_modules/rollup/dist/es/shared/node-entry.js:20936:32
    at Object.logger [as onLog] (file:///home/deployer/smartkubik/food-inventory-admin/node_modules/rollup/dist/es/shared/node-entry.js:22822:9)
    at ModuleLoader.handleInvalidResolvedId (file:///home/deployer/smartkubik/food-inventory-admin/node_modules/rollup/dist/es/shared/node-entry.js:21566:26)
    at file:///home/deployer/smartkubik/food-inventory-admin/node_modules/rollup/dist/es/shared/node-entry.js:21524:26
[0;31m[✗][0m Falló compilación del frontend
[0;31m[✗][0m Deploy falló. Iniciando rollback automático...
[0;34m[INFO][0m Deteniendo PM2...
[PM2] Applying action deleteProcessId on app [all](ids: [ 0, 1 ])
[PM2] [smartkubik-api](1) ✓
[PM2] [smartkubik-api](0) ✓
┌────┬───────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name      │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
└────┴───────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
[0;34m[INFO][0m Restaurando código desde backup...
[0;34m[INFO][0m Restaurando PM2...
[0;34m[INFO][0m Reiniciando aplicación...
[PM2][WARN] Applications smartkubik-api not running, starting...
[PM2] App [smartkubik-api] launched (2 instances)
┌────┬───────────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name              │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
├────┼───────────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
│ 0  │ smartkubik-api    │ default     │ 1.0.0   │ cluster │ 144895   │ 0s     │ 0    │ online    │ 0%       │ 44.7mb   │ deployer │ disabled │
│ 1  │ smartkubik-api    │ default     │ 1.0.0   │ cluster │ 144902   │ 0s     │ 0    │ online    │ 0%       │ 37.8mb   │ deployer │ disabled │
└────┴───────────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
[PM2] Saving current process list...
[PM2] Successfully saved in /home/deployer/.pm2/dump.pm2
[0;32m[✓][0m Rollback completado. Sistema restaurado al estado anterior.
