#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”’ Running security checks before commit..."

# Run linting
echo "ğŸ“ Running ESLint..."
npm run lint || {
  echo "âŒ ESLint failed. Please fix linting errors."
  exit 1
}

# Run security unit tests (fast)
echo "ğŸ›¡ï¸  Running XSS sanitization tests..."
npm run test:security:unit -- --passWithNoTests || {
  echo "âŒ Security unit tests failed!"
  exit 1
}

# Check for common security anti-patterns
echo "ğŸ” Checking for security anti-patterns..."

# Check for hardcoded secrets
if git diff --cached | grep -iE "(password|secret|api_key|token)\s*=\s*['\"][^'\"]{8,}"; then
  echo "âš ï¸  WARNING: Possible hardcoded secret detected!"
  echo "   Please use environment variables instead."
  exit 1
fi

# Check for console.log with sensitive data
if git diff --cached | grep -E "console\.(log|debug|info).*\b(password|token|secret)\b"; then
  echo "âš ï¸  WARNING: Possible sensitive data in console.log!"
  exit 1
fi

# Check for disabled security features
if git diff --cached | grep -E "(helmet.*false|csrf.*false|sanitize.*false)"; then
  echo "âš ï¸  WARNING: Security feature appears to be disabled!"
  exit 1
fi

echo "âœ… All security checks passed!"
